<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</title>
    <style>
        body { font-family: 'Tahoma', sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; color: #333; }
        .screen { display: none; padding: 20px; max-width: 100%; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-top: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            box-sizing: border-box;
        }
        button { 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #45a049; }
        .error { color: red; margin: 10px 0; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: right; 
        }
        th { 
            background-color: #f2f2f2; 
            position: sticky;
            top: 0;
        }
        .text-success { color: green; }
        .text-danger { color: red; }
        .text-warning { color: orange; }
        .btn-edit { background-color: #2196F3; }
        .btn-delete { background-color: #f44336; }
        .report-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .no-data { 
            text-align: center; 
            padding: 40px;
            color: #666;
        }
        @media print {
            body * { visibility: hidden; }
            #reportContent, #reportContent * { visibility: visible; }
            #reportContent { position: absolute; left: 0; top: 0; width: 100%; }
        }
        @media (max-width: 768px) {
            .report-header { flex-direction: column; align-items: flex-start; }
            button { margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
    <div id="welcomeScreen" class="screen">
        <h1 style="text-align: center; margin-top: 100px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</h1>
        <p style="text-align: center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen" class="screen">
        <div style="max-width: 400px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="text-align: center; color: #2c3e50;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <div class="form-group">
                <label for="empId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                <input type="text" id="empId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
            </div>
            <div class="form-group">
                <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <div id="loginErrors" class="error"></div>
            <button onclick="login()" style="margin-top: 20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dashboardScreen" class="screen">
        <div style="max-width: 600px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 id="userWelcome" style="text-align: center; color: #2c3e50;"></h2>
            <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                <button onclick="openScreen('entryScreen')">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button onclick="openScreen('reportScreen')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                <button id="settingsBtn" onclick="openScreen('settingsScreen')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button id="usersBtn" onclick="openScreen('usersScreen')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                <button onclick="logout()" style="background-color: #f44336;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div id="entryScreen" class="screen">
        <div style="max-width: 800px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="text-align: center; color: #2c3e50;">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="dataForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="dateInput">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ:</label>
                        <input type="date" id="dateInput" required>
                    </div>
                    <div class="form-group">
                        <label for="siteName">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                        <input type="text" id="siteName" required>
                    </div>
                    <div class="form-group">
                        <label for="barnName">Ø§Ø³Ù… Ø§Ù„Ø­Ø¸ÙŠØ±Ø©:</label>
                        <input type="text" id="barnName" required>
                    </div>
                    <div class="form-group">
                        <label for="licenseNo">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©:</label>
                        <input type="text" id="licenseNo">
                    </div>
                    <div class="form-group">
                        <label for="animalType">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</label>
                        <select id="animalType" required></select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</label>
                        <select id="gender" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
                            <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                            <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sampleType">Ù†ÙˆØ¹ Ø§Ù„Ø¹ÙŠÙ†Ø©:</label>
                        <select id="sampleType" required></select>
                    </div>
                    <div class="form-group">
                        <label for="testType">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                        <select id="testType" required></select>
                    </div>
                    <div class="form-group">
                        <label for="resultType">Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ:</label>
                        <select id="resultType" required></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <div id="entryErrors" class="error"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button type="button" onclick="goBack()" style="background-color: #f44336;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="reportScreen" class="screen">
        <div style="max-width: 1000px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="text-align: center; color: #2c3e50;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label for="fromDate">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label for="toDate">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="toDate">
                </div>
            </div>
            <button onclick="generateReport()" style="margin-bottom: 20px;">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button onclick="goBack()" style="background-color: #f44336; margin-bottom: 20px;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <div id="reportContent"></div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="settingsScreen" class="screen">
        <div style="max-width: 800px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="text-align: center; color: #2c3e50;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            <div class="form-group">
                <label for="sampleList">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©):</label>
                <textarea id="sampleList" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="testList">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©):</label>
                <textarea id="testList" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="resultList">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©):</label>
                <textarea id="resultList" rows="3"></textarea>
            </div>
            <div id="settingsErrors" class="error"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button onclick="goBack()" style="background-color: #f44336;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div id="usersScreen" class="screen">
        <div style="max-width: 1000px; margin: 20px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="text-align: center; color: #2c3e50;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            
            <h3 style="margin-top: 30px;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="newEmpId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                    <input type="text" id="newEmpId">
                </div>
                <div class="form-group">
                    <label for="newName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                    <input type="text" id="newName">
                </div>
                <div class="form-group">
                    <label for="newType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                    <select id="newType">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                        <option value="Ù…Ø³Ø¤ÙˆÙ„">Ù…Ø³Ø¤ÙˆÙ„</option>
                        <option value="ÙÙ†ÙŠ">ÙÙ†ÙŠ</option>
                        <option value="Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ§Ø´ÙŠ">Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ§Ø´ÙŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newSite">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                    <input type="text" id="newSite">
                </div>
                <div class="form-group">
                    <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="newPassword">
                </div>
            </div>
            <div id="userErrors" class="error"></div>
            <button onclick="addUser()" style="margin-bottom: 30px;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
            
            <h3 style="border-top: 1px solid #eee; padding-top: 20px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <div id="usersList"></div>
            <button onclick="goBack()" style="background-color: #f44336; margin-top: 20px;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, getDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAzXj2yxeKNUgw2wbyP5C6MKrj92A5-ZS8",
            authDomain: "vet-lab-data.firebaseapp.com",
            projectId: "vet-lab-data",
            storageBucket: "vet-lab-data.appspot.com",
            messagingSenderId: "817190318140",
            appId: "1:817190318140:web:fe1827b6b226ddca4f1339",
            measurementId: "G-NQ6LC0VFQ1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Application data
        let users = [];
        let currentUser = null;
        let entries = [];
        let settings = {
            samples: ["Ø¯Ù…", "Ø¨ÙˆÙ„", "Ø®Ø²Ø¹Ø©"],
            tests: ["ÙØ­Øµ Ø¯Ù…", "ÙØ­Øµ Ø¨ÙˆÙ„", "ÙØ­Øµ Ø£Ù†Ø³Ø¬Ø©"],
            results: ["Ø³Ù„ÙŠÙ…", "Ù…Ø±ÙŠØ¶", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"]
        };

        // Animal types
        const animalTypes = [
            {en: "Sheep", ar: "Ø®Ø±ÙˆÙ"},
            {en: "Goat", ar: "Ù…Ø§Ø¹Ø²"},
            {en: "Cow", ar: "Ø¨Ù‚Ø±"},
            {en: "Camel", ar: "Ø¬Ù…Ø§Ù„"}
        ];

        // ==================== Core Functions ====================

        async function startApp() {
            showScreen("welcomeScreen");
            setTimeout(() => showScreen("loginScreen"), 2000);

            // Load data from Firebase
            try {
                await Promise.all([
                    loadUsersFromFirebase(),
                    loadEntriesFromFirebase(),
                    loadSettingsFromFirebase()
                ]);
                
                // Initialize form fields
                populateAnimalTypes();
                populateSelect("sampleType", settings.samples);
                populateSelect("testType", settings.tests);
                populateSelect("resultType", settings.results);

                // Set today's date as default
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById("dateInput").value = today;
                document.getElementById("fromDate").value = today;
                document.getElementById("toDate").value = today;

                // Setup form handler
                document.getElementById("dataForm").addEventListener("submit", function(e) {
                    e.preventDefault();
                    saveEntry();
                });

                // Hide admin buttons initially
                document.getElementById("settingsBtn").style.display = "none";
                document.getElementById("usersBtn").style.display = "none";
            } catch (error) {
                console.error("Initialization error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
            }
        }

        // ==================== Firebase Operations ====================

        async function loadUsersFromFirebase() {
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                users = querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error("Error loading users:", error);
                throw error;
            }
        }

        async function loadEntriesFromFirebase() {
            try {
                const querySnapshot = await getDocs(collection(db, "entries"));
                entries = querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error("Error loading entries:", error);
                throw error;
            }
        }

        async function loadSettingsFromFirebase() {
            try {
                const docRef = doc(db, "settings", "appSettings");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    settings = docSnap.data();
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                throw error;
            }
        }

        async function saveUserToFirebase(user) {
            try {
                await setDoc(doc(db, "users", user.empId), user);
            } catch (error) {
                console.error("Error saving user:", error);
                throw error;
            }
        }

        async function saveEntryToFirebase(entry) {
            try {
                await addDoc(collection(db, "entries"), entry);
            } catch (error) {
                console.error("Error saving entry:", error);
                throw error;
            }
        }

        async function saveSettingsToFirebase() {
            try {
                await setDoc(doc(db, "settings", "appSettings"), settings);
            } catch (error) {
                console.error("Error saving settings:", error);
                throw error;
            }
        }

        async function deleteUserFromFirebase(empId) {
            try {
                await deleteDoc(doc(db, "users", empId));
            } catch (error) {
                console.error("Error deleting user:", error);
                throw error;
            }
        }

        // ==================== Authentication ====================

        async function login() {
            const empId = document.getElementById("empId").value.trim();
            const password = document.getElementById("password").value;
            const errorElement = document.getElementById("loginErrors");

            errorElement.textContent = "";

            if (!empId || !password) {
                errorElement.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(
                    auth, 
                    `${empId}@vetlab.com`, 
                    password
                );
                
                const user = users.find(u => u.empId === empId);
                
                if (user) {
                    currentUser = user;
                    updateUserWelcome();
                    showScreen("dashboardScreen");
                    
                    // Show/hide admin buttons based on permissions
                    const isAdmin = user.permissions?.manageUsers || false;
                    document.getElementById("settingsBtn").style.display = isAdmin ? "block" : "none";
                    document.getElementById("usersBtn").style.display = isAdmin ? "block" : "none";
                } else {
                    errorElement.textContent = "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…";
                    await signOut(auth);
                }
            } catch (error) {
                console.error("Login error:", error);
                errorElement.textContent = "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + 
                    (error.code === 'auth/wrong-password' ? "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©" : 
                     error.code === 'auth/user-not-found' ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" : 
                     "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
            }
        }

        async function logout() {
            if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                try {
                    await signOut(auth);
                    currentUser = null;
                    showScreen("loginScreen");
                } catch (error) {
                    console.error("Logout error:", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
                }
            }
        }

        // ==================== Application Functions ====================

        function showScreen(screenId) {
            document.querySelectorAll(".screen").forEach(screen => {
                screen.style.display = "none";
            });
            document.getElementById(screenId).style.display = "block";
            window.scrollTo(0, 0);
        }

        function openScreen(screenId) {
            showScreen(screenId);
            
            if (screenId === "dashboardScreen") {
                updateUserWelcome();
            } 
            else if (screenId === "entryScreen") {
                clearEntryForm();
            }
            else if (screenId === "settingsScreen") {
                loadSettings();
            }
            else if (screenId === "usersScreen") {
                loadUsersList();
            }
        }

        function updateUserWelcome() {
            if (currentUser) {
                document.getElementById("userWelcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`;
                document.getElementById("siteName").value = currentUser.site || "";
            }
        }

        function populateAnimalTypes() {
            const select = document.getElementById("animalType");
            select.innerHTML = '';
            
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†";
            select.appendChild(defaultOption);

            animalTypes.forEach(animal => {
                const opt = document.createElement("option");
                opt.value = animal.en;
                opt.textContent = animal.ar;
                select.appendChild(opt);
            });
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = '';
            
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = `Ø§Ø®ØªØ± ${id === 'sampleType' ? 'Ù†ÙˆØ¹ Ø§Ù„Ø¹ÙŠÙ†Ø©' : 
                                      id === 'testType' ? 'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ'}`;
            select.appendChild(defaultOption);

            options.forEach(option => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }

        function clearEntryForm() {
            document.getElementById("dataForm").reset();
            document.getElementById("siteName").value = currentUser?.site || "";
            document.getElementById("dateInput").value = new Date().toISOString().slice(0, 10);
            document.getElementById("entryErrors").textContent = "";
        }

        async function saveEntry() {
            const errorElement = document.getElementById("entryErrors");
            errorElement.textContent = "";

            const animalType = document.getElementById("animalType");
            const animalTypeText = animalType.options[animalType.selectedIndex].text;

            const entry = {
                date: document.getElementById("dateInput").value,
                site: document.getElementById("siteName").value,
                barnName: document.getElementById("barnName").value.trim(),
                licenseNo: document.getElementById("licenseNo").value.trim(),
                animalType: animalTypeText,
                animalTypeEn: animalType.value,
                gender: document.getElementById("gender").value,
                sampleType: document.getElementById("sampleType").value,
                testType: document.getElementById("testType").value,
                resultType: document.getElementById("resultType").value,
                notes: document.getElementById("notes").value.trim(),
                enteredBy: currentUser.name,
                entryDate: new Date().toISOString()
            };

            // Validation
            const errors = [];
            if (!entry.date) errors.push("ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.site) errors.push("Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.barnName) errors.push("Ø§Ø³Ù… Ø§Ù„Ø­Ø¸ÙŠØ±Ø© Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.animalType) errors.push("Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.gender) errors.push("Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.sampleType) errors.push("Ù†ÙˆØ¹ Ø§Ù„Ø¹ÙŠÙ†Ø© Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.testType) errors.push("Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø·Ù„ÙˆØ¨");
            if (!entry.resultType) errors.push("Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ Ù…Ø·Ù„ÙˆØ¨Ø©");

            if (errors.length > 0) {
                errorElement.textContent = errors.join("ØŒ ");
                return;
            }

            try {
                await saveEntryToFirebase(entry);
                entries.push(entry);
                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                clearEntryForm();
                goBack();
            } catch (error) {
                errorElement.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message;
            }
        }

        function generateReport() {
            const fromDate = document.getElementById("fromDate").value;
            const toDate = document.getElementById("toDate").value;
            const reportContent = document.getElementById("reportContent");

            if (!fromDate || !toDate) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©");
                return;
            }

            const filteredEntries = entries.filter(entry => {
                return entry.date >= fromDate && entry.date <= toDate;
            });

            if (filteredEntries.length === 0) {
                reportContent.innerHTML = `
                    <div class="no-data">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                    </div>
                `;
                return;
            }

            const reportDate = new Date().toLocaleDateString('ar-EG');
            
            let html = `
                <div class="report-header">
                    <div>
                        <div class="report-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</div>
                        <div class="report-meta">Ø§Ù„ÙØªØ±Ø© Ù…Ù† ${fromDate} Ø¥Ù„Ù‰ ${toDate} - ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${reportDate}</div>
                    </div>
                    <div>
                        <button class="export-btn" onclick="exportToExcel()">ØªØµØ¯ÙŠØ± Ù„Ø¥ÙƒØ³Ù„</button>
                        <button class="print-btn" onclick="printReport()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                            <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredEntries.forEach((entry, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${entry.date}</td>
                        <td>${entry.site}</td>
                        <td>${entry.animalType}</td>
                        <td>${entry.testType}</td>
                        <td class="${entry.resultType === 'Ø³Ù„ÙŠÙ…' ? 'text-success' : 
                                    entry.resultType === 'Ù…Ø±ÙŠØ¶' ? 'text-danger' : 'text-warning'}">
                            ${entry.resultType}
                        </td>
                        <td>${entry.notes || '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            reportContent.innerHTML = html;
        }

        function printReport() {
            const printContent = document.getElementById("reportContent").innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding:20px;font-family:'Tahoma'">
                    <h1 style="text-align:center;margin-bottom:30px">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</h1>
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            showScreen("reportScreen");
        }

        function exportToExcel() {
            const table = document.querySelector("#reportContent table");
            if (!table) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll("tr");
            
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                
                for (let j = 0; j < cols.length; j++) {
                    row.push(cols[j].innerText);
                }
                
                csv.push(row.join(","));
            }

            const csvContent = csv.join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø®ØªØ¨Ø±_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = "hidden";
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadSettings() {
            document.getElementById("sampleList").value = settings.samples.join(", ");
            document.getElementById("testList").value = settings.tests.join(", ");
            document.getElementById("resultList").value = settings.results.join(", ");
            document.getElementById("settingsErrors").textContent = "";
        }

        async function saveSettings() {
            const errorElement = document.getElementById("settingsErrors");
            errorElement.textContent = "";

            try {
                settings.samples = document.getElementById("sampleList").value.split(",")
                    .map(item => item.trim()).filter(item => item);
                settings.tests = document.getElementById("testList").value.split(",")
                    .map(item => item.trim()).filter(item => item);
                settings.results = document.getElementById("resultList").value.split(",")
                    .map(item => item.trim()).filter(item => item);

                await saveSettingsToFirebase();
                
                // Update dropdowns
                populateSelect("sampleType", settings.samples);
                populateSelect("testType", settings.tests);
                populateSelect("resultType", settings.results);

                alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            } catch (error) {
                errorElement.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: " + error.message;
            }
        }

        function loadUsersList() {
            const usersList = document.getElementById("usersList");
            usersList.innerHTML = "";

            if (users.length === 0) {
                usersList.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>";
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach((user, index) => {
                html += `
                    <tr>
                        <td>${user.empId}</td>
                        <td>${user.name}</td>
                        <td>${user.type}</td>
                        <td>${user.site}</td>
                        <td>
                            <button onclick="editUser(${index})" class="btn-edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="deleteUser(${index})" class="btn-delete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            usersList.innerHTML = html;
        }

        async function addUser() {
            const errorElement = document.getElementById("userErrors");
            errorElement.textContent = "";

            const empId = document.getElementById("newEmpId").value.trim();
            const name = document.getElementById("newName").value.trim();
            const type = document.getElementById("newType").value;
            const site = document.getElementById("newSite").value.trim();
            const password = document.getElementById("newPassword").value;

            // Validation
            const errors = [];
            if (!empId) errors.push("Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù…Ø·Ù„ÙˆØ¨");
            if (!name) errors.push("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨");
            if (!type) errors.push("Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨");
            if (!site) errors.push("Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨");
            if (!password || password.length < 6) errors.push("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");

            if (errors.length > 0) {
                errorElement.textContent = errors.join("ØŒ ");
                return;
            }

            // Check if user already exists
            if (users.some(u => u.empId === empId)) {
                errorElement.textContent = "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹";
                return;
            }

            // Set permissions based on user type
            const permissions = {
                manageUsers: type === "Ù…Ø³Ø¤ÙˆÙ„",
                manageSettings: type === "Ù…Ø³Ø¤ÙˆÙ„",
                viewReports: true,
                addEntries: true
            };

            const newUser = { empId, name, type, site, permissions };

            try {
                // Create user in Authentication
                await createUserWithEmailAndPassword(
                    auth, 
                    `${empId}@vetlab.com`, 
                    password
                );
                
                // Save user to Firestore
                await saveUserToFirebase(newUser);
                users.push(newUser);
                
                // Clear form
                document.getElementById("newEmpId").value = "";
                document.getElementById("newName").value = "";
                document.getElementById("newType").value = "";
                document.getElementById("newSite").value = "";
                document.getElementById("newPassword").value = "";

                alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
                loadUsersList();
            } catch (error) {
                console.error("Error adding user:", error);
                errorElement.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + 
                    (error.code === 'auth/email-already-in-use' ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„" :
                     error.message);
            }
        }

        function editUser(index) {
            const user = users[index];
            if (!user) return;

            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.name}ØŸ`)) return;

            document.getElementById("newEmpId").value = user.empId;
            document.getElementById("newName").value = user.name;
            document.getElementById("newType").value = user.type;
            document.getElementById("newSite").value = user.site;
            document.getElementById("newPassword").value = "";

            // Remove the old user from the array
            users.splice(index, 1);
        }

        async function deleteUser(index) {
            const user = users[index];
            if (!user) return;

            if (user.empId === "70062") {
                alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ");
                return;
            }

            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.name}ØŸ`)) {
                try {
                    await deleteUserFromFirebase(user.empId);
                    users.splice(index, 1);
                    loadUsersList();
                    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
                } catch (error) {
                    console.error("Error deleting user:", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + error.message);
                }
            }
        }

        function goBack() {
            if (currentUser) {
                showScreen("dashboardScreen");
            } else {
                showScreen("loginScreen");
            }
        }

        // ==================== Initialize App ====================

        window.onload = startApp;
        
        // Expose functions to HTML
        window.login = login;
        window.logout = logout;
        window.openScreen = openScreen;
        window.goBack = goBack;
        window.saveEntry = saveEntry;
        window.generateReport = generateReport;
        window.printReport = printReport;
        window.exportToExcel = exportToExcel;
        window.saveSettings = saveSettings;
        window.addUser = addUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
    </script>
</body>
</html>
